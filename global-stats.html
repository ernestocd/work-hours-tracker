<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Hours Tracker - Global Statistics</title>
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
  <link rel="manifest" href="img/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f7fa;
      padding: 1.5rem;
      color: #333;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a3c34;
      margin-bottom: 1.5rem;
    }
    h5 {
      font-size: 1.1rem;
      font-weight: 500;
      color: #1a3c34;
      margin-bottom: 1rem;
    }
    .stat-box {
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .stat-box hr {
      opacity: 0.25;
      margin: 0.75rem 0;
    }
    .stat-box canvas {
      margin-top: 1rem;
    }
    #calendar-heatmap {
      min-height: 300px;
      width: 100%;
    }
    #weekly-trend-chart {
      min-height: 300px;
      width: 100%;
    }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 2rem;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1rem;
    }
    .table th, .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    .table thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table tbody tr:nth-child(even) {
      background: #f9fbfc;
    }
    .highlight {
      animation: highlight 1s ease-out;
    }
    @keyframes highlight {
      0% { background-color: #e6ffed; }
      100% { background-color: transparent; }
    }
    .editable:hover {
      background-color: #f1f3f5;
      cursor: pointer;
    }
    .btn-sm {
      padding: 0.35rem 0.75rem;
      font-size: 0.875rem;
    }
    .progress {
      height: 0.5rem;
      border-radius: 5px;
      background: #e9ecef;
    }
    .progress-bar {
      background: #1a3c34;
    }
    .btn-outline-secondary {
      border-color: #ced4da;
      color: #555;
    }
    .btn-outline-secondary:hover {
      background-color: #f1f3f5;
      color: #1a3c34;
    }
    .error-message {
      color: #dc3545;
      background: #f8d7da;
      padding: 0.5rem;
      border-radius: 5px;
      font-size: 0.875rem;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a3c34;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .navbar {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 0.5rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .navbar .nav-link {
      color: #1a3c34;
      font-weight: 500;
      margin-right: 1rem;
    }
    .navbar .nav-link.active {
      color: #1a3c34;
      font-weight: 600;
      border-bottom: 2px solid #1a3c34;
    }
    .info-icon {
      cursor: pointer;
      color: #6c757d;
      font-size: 0.9rem;
      margin-left: 0.25rem;
    }
    .info-icon:hover {
      color: #1a3c34;
    }
    .improvement-tips {
      list-style: disc;
      padding-left: 1.5rem;
      margin-bottom: 0;
    }
    .improvement-tips li {
      margin-bottom: 0.25rem;
    }
    .text-success {
      color: #28a745 !important;
    }
    @media (max-width: 576px) {
      body { padding: 1rem; }
      h1 { font-size: 1.5rem; }
      h5 { font-size: 1rem; }
      .stat-box { padding: 1rem; }
      .btn-sm { font-size: 0.75rem; }
      .stat-box p { font-size: 0.8rem; }
      .info-icon { font-size: 0.8rem; }
      #calendar-heatmap { min-height: 200px; }
      #weekly-trend-chart { min-height: 200px; }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Work Hours Tracker</a>
      <div class="navbar-nav">
        <a class="nav-link" href="workweek-stats.html">Workweek Statistics</a>
        <a class="nav-link active" href="global-stats.html">Global Statistics</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-3">📊 Global Statistics</h1>

    <div class="filter-sticky">
      <div class="row g-2 align-items-center">
        <div class="col-12 filter-buttons-row">
          <button type="button" id="toggleTableBtn" class="btn btn-outline-primary action-btn" title="Show/Hide Table" aria-label="Show/Hide Table">📋</button>
        </div>
      </div>
    </div>

    <div class="loading-spinner" id="loadingSpinner"></div>
    <div id="fallbackMessage" class="error-message" style="display: none;">Failed to load data. Please refresh the page.</div>

    <div class="table-container" id="tableContainer" style="display: none;">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Hours</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entriesTable">
          <tr id="addRow">
            <td><input type="date" id="newDate" class="form-control" aria-label="New Date" /></td>
            <td><input type="number" id="newHours" class="form-control" step="0.1" min="0" placeholder="Hours" aria-label="New Hours" /></td>
            <td><button id="addBtn" class="btn btn-success btn-sm">Add New</button></td>
          </tr>
        </tbody>
      </table>
      <div class="mb-3">
        <button id="exportCsvBtn" class="btn btn-outline-primary btn-sm me-2">Export to CSV</button>
        <button id="exportExcelBtn" class="btn btn-outline-primary btn-sm">Export to Excel</button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 stat-box">
        <h5>Total Work Summary</h5>
        <p><strong id="globalTotal">0</strong> hrs across <span id="weeksCount">0</span> weeks</p>
        <div class="progress mb-2">
          <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%;"></div>
        </div>
        <p id="progressPercent" class="text-muted small"></p>
        <p id="progressStatus" class="text-muted small"></p>
        <p id="totalSummaryNote" class="text-muted small"></p>
        <canvas id="donutChart"></canvas>
      </div>

      <div class="col-md-4 stat-box">
        <h5>Work Insights</h5>
        <p>Total Hours: <strong id="globalTotalHours">0</strong></p>
        <p>Weeks Tracked: <strong id="weeksTracked">0</strong></p>
        <p>Avg hrs/Week: <strong id="globalAvg">0</strong></p>
        <p>Successful Weeks: <strong id="goalWeeks">0</strong></p>
        <p>Days Worked: <strong id="daysWorked">0/0</strong></p>
        <hr class="my-2 opacity-25">
        <p>Longest Day Worked: <strong id="longestDayWorked">0 hrs</strong></p>
        <p>Avg hrs/Day: <strong id="avgHoursDay">0</strong></p>
        <canvas id="worked-vs-not-worked-chart"></canvas>
      </div>

      <div class="col-md-4 stat-box">
        <h5>Real-World Comparison</h5>
        <p>Weekly Hours vs Full-Time Goal: <strong id="weeklyVsFullTime">0%</strong> <span class="info-icon" data-bs-toggle="tooltip" data-bs-title="Your average weekly hours compared to a full-time 40-hour schedule." data-description="Your average weekly hours compared to a full-time 40-hour schedule." data-bs-placement="right">ⓘ</span></p>
        <p>Performance Level: <strong id="performanceLevel">N/A</strong> <span class="info-icon" data-bs-toggle="tooltip" data-bs-title="How your hours rate: Excellent (90%+), Adequate (75–89%), Below Average (60–74%), Inconsistent (40–59%), Minimal Effort (20–39%), Negligible (<20%)." data-description="How your hours rate: Excellent (90%+), Adequate (75–89%), Below Average (60–74%), Inconsistent (40–59%), Minimal Effort (20–39%), Negligible (<20%)." data-bs-placement="right">ⓘ</span></p>
        <p>Workday Participation: <strong id="workdayParticipation">0%</strong> <span class="info-icon" data-bs-toggle="tooltip" data-bs-title="Percentage of expected workdays (5 days/week, excluding holidays) with any hours worked." data-description="Percentage of expected workdays (5 days/week, excluding holidays) with any hours worked." data-bs-placement="right">ⓘ</span></p>
        <p>Last 4 Weeks vs Full-Time Goal: <strong id="recentProgress">0%</strong> <span class="info-icon" data-bs-toggle="tooltip" data-bs-title="Recent hours vs full-time 40-hour goal, showing trends." data-description="Recent hours vs full-time 40-hour goal, showing trends." data-bs-placement="right">ⓘ</span></p>
        <p>Steps to Full-Time: <strong id="stepsToFullTime">0 hrs/week</strong> <span class="info-icon" data-bs-toggle="tooltip" data-bs-title="Additional hours needed per week to reach full-time 40 hours." data-description="Additional hours needed per week to reach full-time 40 hours." data-bs-placement="right">ⓘ</span></p>
        <p class="text-muted small" id="realWorldMessage"></p>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 stat-box">
        <h5>Weekly Hours Trend</h5>
        <p class="text-muted small">Weekly hours compared to the full-time 40-hour goal over time.</p>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeWeeklyTrendBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeWeeklyTrendBtn" aria-label="Minimize Chart">Minimize</button>
        <canvas id="weekly-trend-chart"></canvas>
      </div>
      <div class="col-md-6 stat-box">
        <h5>Calendar Heatmap</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeCalendarBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeCalendarBtn" aria-label="Minimize Chart">Minimize</button>
        <div id="calendar-heatmap"></div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 stat-box">
        <h5>Heatmap Statistics (Days)</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeHeatmapStatsBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeHeatmapStatsBtn" aria-label="Minimize Chart">Minimize</button>
        <canvas id="heatmap-stats-pie"></canvas>
      </div>
    </div>

    <div class="modal fade" id="infoModal" tabindex="-1" aria-labelledby="infoModalLabel" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="infoModalLabel">Metric Description</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body" id="infoModalBody"></div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      "use strict";

      const state = {
        allEntries: [],
        charts: {
          donutChart: null,
          calendarChart: null,
          heatmapStatsPie: null,
          workedVsNotWorkedChart: null,
          weeklyTrendChart: null
        }
      };

      const elements = {
        entriesTable: document.getElementById("entriesTable"),
        exportCsvBtn: document.getElementById("exportCsvBtn"),
        exportExcelBtn: document.getElementById("exportExcelBtn"),
        newDateInput: document.getElementById("newDate"),
        newHoursInput: document.getElementById("newHours"),
        addBtn: document.getElementById("addBtn"),
        toggleTableBtn: document.getElementById("toggleTableBtn"),
        tableContainer: document.getElementById("tableContainer"),
        globalTotal: document.getElementById("globalTotal"),
        globalTotalHours: document.getElementById("globalTotalHours"),
        weeksCount: document.getElementById("weeksCount"),
        progressBar: document.getElementById("progressBar"),
        progressPercent: document.getElementById("progressPercent"),
        progressStatus: document.getElementById("progressStatus"),
        totalSummaryNote: document.getElementById("totalSummaryNote"),
        weeksTracked: document.getElementById("weeksTracked"),
        globalAvg: document.getElementById("globalAvg"),
        goalWeeks: document.getElementById("goalWeeks"),
        daysWorked: document.getElementById("daysWorked"),
        longestDayWorked: document.getElementById("longestDayWorked"),
        avgHoursDay: document.getElementById("avgHoursDay"),
        weeklyVsFullTime: document.getElementById("weeklyVsFullTime"),
        performanceLevel: document.getElementById("performanceLevel"),
        workdayParticipation: document.getElementById("workdayParticipation"),
        recentProgress: document.getElementById("recentProgress"),
        stepsToFullTime: document.getElementById("stepsToFullTime"),
        realWorldMessage: document.getElementById("realWorldMessage"),
        donutChart: document.getElementById("donutChart"),
        calendarHeatmap: document.getElementById("calendar-heatmap"),
        maximizeCalendarBtn: document.getElementById("maximizeCalendarBtn"),
        minimizeCalendarBtn: document.getElementById("minimizeCalendarBtn"),
        heatmapStatsPie: document.getElementById("heatmap-stats-pie"),
        maximizeHeatmapStatsBtn: document.getElementById("maximizeHeatmapStatsBtn"),
        minimizeHeatmapStatsBtn: document.getElementById("minimizeHeatmapStatsBtn"),
        weeklyTrendChart: document.getElementById("weekly-trend-chart"),
        maximizeWeeklyTrendBtn: document.getElementById("maximizeWeeklyTrendBtn"),
        minimizeWeeklyTrendBtn: document.getElementById("minimizeWeeklyTrendBtn"),
        loadingSpinner: document.getElementById("loadingSpinner"),
        infoModalBody: document.getElementById("infoModalBody"),
        fallbackMessage: document.getElementById("fallbackMessage")
      };

      const firebaseConfig = {
        apiKey: "AIzaSyAnujd0rgEBYUVly32YOsQNBnuOYzVw8u0",
        authDomain: "work-hours-tracker-f48a6.firebaseapp.com",
        databaseURL: "https://work-hours-tracker-f48a6-default-rtdb.firebaseio.com",
        projectId: "work-hours-tracker-f48a6",
        storageBucket: "work-hours-tracker-f48a6.appspot.com",
        messagingSenderId: "945814366512",
        appId: "1:945814366512:web:778a312b936701199940f5"
      };

      const getWeekStart = (date) => {
        const d = new Date(date);
        const dayOfWeek = d.getDay();
        const daysToLastSaturday = (dayOfWeek + 1) % 7;
        d.setDate(d.getDate() - daysToLastSaturday);
        d.setHours(0, 0, 0, 0);
        return d;
      };

      const countWeeksInRange = (entries) => {
        if (entries.length === 0) return 0;
        const dates = entries.map(e => new Date(e.date));
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const start = getWeekStart(minDate);
        const end = getWeekStart(maxDate);
        const diffTime = Math.abs(end - start);
        const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000)) + 1;
        return Math.max(1, diffWeeks);
      };

      const showError = (message) => {
        elements.progressStatus.classList.add("error-message");
        elements.progressStatus.textContent = message;
        setTimeout(() => clearError(), 5000);
      };

      const clearError = () => {
        elements.progressStatus.classList.remove("error-message");
        elements.progressStatus.textContent = "";
      };

      let db;
      const initializeFirebase = () => {
        try {
          firebase.initializeApp(firebaseConfig);
          db = firebase.database();
          console.log("Firebase initialized successfully");
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          showError("Failed to connect to database. Please check your internet connection.");
          elements.loadingSpinner.style.display = "none";
          throw error;
        }
      };

      const loadEntries = () => {
        elements.loadingSpinner.style.display = "block";
        console.log("Attempting to fetch entries from Firebase...");
        db.ref("entries").on("value", (snapshot) => {
          try {
            const data = snapshot.val() || {};
            console.log("Firebase snapshot:", data);
            state.allEntries = Object.entries(data).map(([id, entry]) => {
              if (!entry || !entry.date || typeof entry.hours === "undefined") return null;
              const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
              if (!dateRegex.test(entry.date)) return null;
              const hours = parseFloat(entry.hours);
              if (isNaN(hours) || hours < 0) return null;
              return { id, date: entry.date, hours };
            }).filter(entry => entry !== null);

            console.log(`Loaded ${state.allEntries.length} entries`);
            if (state.allEntries.length === 0) {
              showError("No data found. Add entries to start tracking.");
              elements.tableContainer.style.display = "block";
              elements.loadingSpinner.style.display = "none";
              return;
            }

            updateUI(state.allEntries);
            elements.loadingSpinner.style.display = "none";
          } catch (error) {
            console.error("Error loading entries:", error);
            showError("Failed to load data. Check your connection or try again.");
            elements.loadingSpinner.style.display = "none";
          }
        }, (error) => {
          console.error("Firebase database error:", error);
          showError("Database error. Please check your connection and retry.");
          elements.loadingSpinner.style.display = "none";
          const retryBtn = document.createElement("button");
          retryBtn.className = "btn btn-primary mt-2";
          retryBtn.textContent = "Retry";
          retryBtn.onclick = loadEntries;
          elements.loadingSpinner.insertAdjacentElement("afterend", retryBtn);
        });
      };

      const renderTable = (entries) => {
        const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));
        const rows = sortedEntries.map(entry => `
          <tr data-id="${entry.id}">
            <td><input type="date" class="form-control editable date-field" value="${entry.date}" aria-label="Edit Date" /></td>
            <td><input type="number" class="form-control editable hours-field" value="${entry.hours}" step="0.1" min="0" aria-label="Edit Hours" /></td>
            <td><button class="btn btn-danger btn-sm delete-btn" aria-label="Delete Entry">🗑️</button></td>
          </tr>
        `).join("");
        elements.entriesTable.innerHTML = `
          <tr id="addRow">
            <td><input type="date" id="newDate" class="form-control" aria-label="New Date" /></td>
            <td><input type="number" id="newHours" class="form-control" step="0.1" min="0" placeholder="Hours" aria-label="New Hours" /></td>
            <td><button id="addBtn" class="btn btn-success btn-sm" aria-label="Add New Entry">Add New</button></td>
          </tr>
          ${rows}
        `;
      };

      const updateUI = (entries) => {
        if (!elements.weeklyTrendChart || !elements.calendarHeatmap || !elements.heatmapStatsPie) {
          console.error("Missing DOM elements for widgets");
          showError("Page rendering error. Please refresh.");
          return;
        }
        renderTable(entries);
        updateTotalStats(entries);
        updateGlobalStats(entries);
        renderHeatmapStatsPie(entries);
        setTimeout(() => renderCalendarHeatmap(entries), 100); // Delay for DOM rendering
      };

      const updateTotalStats = (entries) => {
        const totalHours = entries.reduce((sum, e) => sum + e.hours, 0);
        const weeksInPeriod = countWeeksInRange(entries);
        const expectedHours = weeksInPeriod * 40; // 40 hours/week

        elements.globalTotal.textContent = totalHours.toFixed(2);
        elements.weeksCount.textContent = weeksInPeriod;

        const percent = expectedHours > 0 ? Math.min(100, (totalHours / expectedHours) * 100) : 0;
        elements.progressBar.style.width = `${percent}%`;
        elements.progressPercent.textContent = `${percent.toFixed(2)}%`;

        let status = totalHours >= expectedHours
          ? "✅ Goal met!"
          : `❌ ${(expectedHours - totalHours).toFixed(2)} hrs short`;
        if (totalHours > expectedHours) {
          status = `➕ ${(totalHours - expectedHours).toFixed(2)} hrs over`;
        }
        elements.progressStatus.textContent = status;

        elements.totalSummaryNote.textContent = "Total hours are the sum of all recorded hours, shown with two decimal places. Expected hours are based on a 40-hour/week full-time schedule.";

        if (state.charts.donutChart) state.charts.donutChart.destroy();
        const workedPercent = expectedHours > 0 ? (totalHours / expectedHours * 100).toFixed(2) : 0;
        const remainingPercent = expectedHours > 0 ? ((expectedHours - totalHours) / expectedHours * 100).toFixed(2) : 0;
        state.charts.donutChart = new Chart(elements.donutChart, {
          type: "doughnut",
          data: {
            labels: [
              `Worked: ${totalHours.toFixed(2)} (${workedPercent}%)`,
              `Remaining: ${Math.max(0, expectedHours - totalHours).toFixed(2)} (${remainingPercent}%)`
            ],
            datasets: [{ data: [totalHours, Math.max(0, expectedHours - totalHours)], backgroundColor: ["#1a3c34", "#e9ecef"] }]
          },
          options: {
            cutout: "75%",
            plugins: { legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } } }
          }
        });
      };

      const updateGlobalStats = (entries) => {
        const globalTotal = entries.reduce((sum, e) => sum + e.hours, 0);
        const weeks = {};
        const uniqueDays = new Set();
        const hoursByDate = {};
        entries.forEach(e => {
          const weekStart = getWeekStart(new Date(e.date)).toISOString().split("T")[0];
          weeks[weekStart] = (weeks[weekStart] || 0) + e.hours;
          if (e.hours > 0) uniqueDays.add(e.date);
          hoursByDate[e.date] = (hoursByDate[e.date] || 0) + e.hours;
        });

        const totalWeeks = countWeeksInRange(entries);
        const totalDays = new Set(entries.map(e => e.date)).size;
        const daysWorkedCount = uniqueDays.size;
        const daysNotWorked = totalDays - daysWorkedCount;
        const avgWeek = totalWeeks > 0 ? globalTotal / totalWeeks : 0;
        const avgDay = totalDays > 0 ? globalTotal / totalDays : 0;
        const maxDay = Object.values(hoursByDate).length > 0 ? Math.max(...Object.values(hoursByDate), 0) : 0;
        const goalWeeks = Object.values(weeks).filter(hours => hours >= 40).length;

        const fourWeeksAgo = new Date(new Date(entries[entries.length - 1]?.date || new Date()).setDate(new Date(entries[entries.length - 1]?.date || new Date()).getDate() - 28));
        const recentEntries = entries.filter(e => new Date(e.date) >= fourWeeksAgo);
        const recentTotal = recentEntries.reduce((sum, e) => sum + e.hours, 0);
        const recentWeeks = countWeeksInRange(recentEntries);
        const recentAvgWeek = recentWeeks > 0 ? recentTotal / recentWeeks : 0;

        const holidays = ["2024-11-28", "2024-12-25"];
        const expectedWorkDays = totalWeeks * 5 - holidays.filter(h => {
          const date = new Date(h);
          return date >= new Date("2024-12-14") && date <= new Date("2025-04-18");
        }).length;
        const expectedHoursPerWeek = 40; // Fixed 40 hours/week

        const avgVsFullTimePercent = totalWeeks > 0 ? (avgWeek / expectedHoursPerWeek) * 100 : 0;
        const recentAvgVsFullTimePercent = recentWeeks > 0 ? (recentAvgWeek / expectedHoursPerWeek) * 100 : 0;
        const attendancePercent = expectedWorkDays > 0 ? Math.round((daysWorkedCount / expectedWorkDays) * 100) : 0;

        let performanceLevel = "N/A";
        if (avgVsFullTimePercent >= 90) performanceLevel = "Excellent";
        else if (avgVsFullTimePercent >= 75) performanceLevel = "Adequate";
        else if (avgVsFullTimePercent >= 60) performanceLevel = "Below Average";
        else if (avgVsFullTimePercent >= 40) performanceLevel = "Inconsistent";
        else if (avgVsFullTimePercent >= 20) performanceLevel = "Minimal Effort";
        else if (avgVsFullTimePercent > 0) performanceLevel = "Negligible";

        elements.globalTotalHours.textContent = globalTotal.toFixed(2);
        elements.weeksTracked.textContent = totalWeeks;
        elements.globalAvg.textContent = avgWeek.toFixed(1);
        elements.avgHoursDay.textContent = avgDay.toFixed(1);
        elements.longestDayWorked.textContent = maxDay.toFixed(1) + " hrs";
        elements.goalWeeks.textContent = goalWeeks;
        elements.daysWorked.textContent = `${daysWorkedCount}/${totalDays}`;
        elements.weeklyVsFullTime.textContent = avgVsFullTimePercent.toFixed(1) + "%";
        elements.performanceLevel.textContent = performanceLevel;
        elements.workdayParticipation.textContent = attendancePercent + "%";
        elements.recentProgress.textContent = recentAvgVsFullTimePercent.toFixed(1) + "%";
        const hoursToFullTime = expectedHoursPerWeek - avgWeek;
        elements.stepsToFullTime.textContent = hoursToFullTime.toFixed(1) + " hrs/week";

        if (recentAvgVsFullTimePercent > avgVsFullTimePercent) {
          elements.recentProgress.classList.add("text-success");
          elements.recentProgress.insertAdjacentHTML("afterend", `<span class="text-success small">↑ Improving!</span>`);
        }

        elements.realWorldMessage.textContent = `Over ${totalWeeks} weeks, you averaged ${avgVsFullTimePercent.toFixed(1)}% of a full-time ${expectedHoursPerWeek}-hour/week schedule. You worked ${attendancePercent}% of expected workdays (5 days/week), missing ~${Math.round((100 - attendancePercent) / 100 * 5)} workdays/week. Only ${goalWeeks} of ${totalWeeks} weeks met full-time hours, falling short of full-time standards. See Weekly Hours Trend for details.`;

        const tips = [];
        if (avgVsFullTimePercent < 90) {
          tips.push(`Add ~${hoursToFullTime.toFixed(1)} hours/week (e.g., ~${(hoursToFullTime / 5).toFixed(1)} hours/day over 5 days) to reach full-time status.`);
        }
        if (attendancePercent < 80) {
          const daysNeeded = Math.ceil((0.8 * expectedWorkDays - daysWorkedCount) / totalWeeks);
          tips.push(`Work at least ${daysNeeded} more days/week to improve consistency.`);
        }
        if (recentAvgVsFullTimePercent > avgVsFullTimePercent) {
          tips.push(`Great job! Your recent ${recentAvgVsFullTimePercent.toFixed(1)}% is an improvement—keep it up!`);
        }
        if (tips.length > 0) {
          elements.realWorldMessage.insertAdjacentHTML("afterend", `
            <ul class="improvement-tips text-muted small mt-2">
              ${tips.map(tip => `<li>${tip}</li>`).join("")}
            </ul>
          `);
        }

        if (state.charts.workedVsNotWorkedChart) state.charts.workedVsNotWorkedChart.destroy();
        state.charts.workedVsNotWorkedChart = new Chart(elements.workedVsNotWorkedChart, {
          type: "doughnut",
          data: {
            labels: [`Worked Days: ${daysWorkedCount} (${Math.round((daysWorkedCount / totalDays) * 100)}%)`, `Not Worked Days: ${daysNotWorked} (${Math.round((daysNotWorked / totalDays) * 100)}%)`],
            datasets: [{ data: [daysWorkedCount, daysNotWorked], backgroundColor: ["#28a745", "#dc3545"] }]
          },
          options: {
            cutout: "75%",
            plugins: {
              legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } },
              title: { display: true, text: "Worked vs Not Worked Days", padding: { top: 10, bottom: 10 }, font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
            }
          }
        });

        const weeksData = {
          "2024-12-14": 34.1, "2024-12-21": 13.9, "2024-12-28": 24.6,
          "2025-01-04": 26.8, "2025-01-11": 27.5, "2025-01-18": 11.5,
          "2025-01-25": 24.5, "2025-02-01": 0, "2025-02-08": 24.2,
          "2025-02-15": 26.9, "2025-02-22": 37, "2025-03-01": 39.8,
          "2025-03-08": 40.6, "2025-03-15": 25.3, "2025-03-22": 35.7,
          "2025-03-29": 26.93, "2025-04-05": 38.45, "2025-04-12": 15.18
        };
        const weekLabels = Object.keys(weeksData).sort();
        const weekHours = weekLabels.map(w => weeksData[w]);
        if (state.charts.weeklyTrendChart) state.charts.weeklyTrendChart.destroy();
        state.charts.weeklyTrendChart = new Chart(elements.weeklyTrendChart, {
          type: "line",
          data: {
            labels: weekLabels.map(w => new Date(w).toLocaleDateString("en-US", { month: "short", day: "numeric" })),
            datasets: [
              { label: "Weekly Hours", data: weekHours, borderColor: "#28a745", fill: false },
              { label: "Full-Time Goal", data: weekLabels.map(() => expectedHoursPerWeek), borderColor: "#1a3c34", borderDash: [5, 5], fill: false }
            ]
          },
          options: {
            plugins: {
              legend: { position: "bottom", labels: { font: { family: "'Inter', sans-serif" } } },
              title: { display: true, text: "Weekly Hours Trend", font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
            },
            scales: {
              y: { beginAtZero: true, title: { display: true, text: "Hours" }, ticks: { font: { family: "'Inter', sans-serif" } } },
              x: { ticks: { font: { family: "'Inter', sans-serif" }, maxRotation: 45, minRotation: 45 } }
            }
          }
        });
      };

      const renderCalendarHeatmap = (entries) => {
        if (!elements.calendarHeatmap) {
          console.error("Calendar heatmap element not found");
          showError("Failed to render heatmap. Please refresh.");
          return;
        }
        if (typeof echarts === "undefined") {
          console.error("ECharts library not loaded");
          elements.calendarHeatmap.innerHTML = `<p class="text-muted">Unable to load heatmap. Check your internet connection.</p>`;
          return;
        }
        if (!entries.length) {
          console.warn("No entries for heatmap");
          elements.calendarHeatmap.innerHTML = `<p class="text-muted">No data to display heatmap.</p>`;
          return;
        }

        try {
          // Check element dimensions
          const rect = elements.calendarHeatmap.getBoundingClientRect();
          console.log("Calendar heatmap dimensions:", { width: rect.width, height: rect.height });
          if (rect.width === 0 || rect.height === 0) {
            console.warn("Calendar heatmap has zero dimensions");
            elements.calendarHeatmap.innerHTML = `<p class="text-muted">Heatmap container not visible. Try resizing the window.</p>`;
            return;
          }

          // Dispose existing chart
          if (state.charts.calendarChart) state.charts.calendarChart.dispose();
          state.charts.calendarChart = echarts.init(elements.calendarHeatmap);

          // Prepare data
          const data = entries.map(entry => {
            if (!entry.date || isNaN(entry.hours)) {
              console.warn(`Invalid entry: ${JSON.stringify(entry)}`);
              return null;
            }
            return [entry.date, entry.hours];
          }).filter(d => d !== null);
          console.log("Heatmap data:", data);
          if (!data.length) {
            console.warn("No valid data for heatmap");
            elements.calendarHeatmap.innerHTML = `<p class="text-muted">No valid data for heatmap.</p>`;
            return;
          }

          // Configure chart
          const maxHours = entries.length > 0 ? Math.max(...entries.map(entry => entry.hours)) : 10;
          const maxValue = Math.ceil(maxHours);
          const startDate = new Date("2024-12-14");
          const endDate = new Date("2025-04-18");
          const pieces = [
            { value: 0, label: '0 hrs (No Work)', color: '#dc3545' },
            { min: 0, max: 2, label: '0-2 hrs', color: '#e6f3ff' },
            { min: 2, max: 4, label: '2-4 hrs', color: '#b3d9ff' },
            { min: 4, max: 6, label: '4-6 hrs', color: '#80bfff' },
            { min: 6, max: 8, label: '6-8 hrs', color: '#4d94ff' },
            { min: 8, label: '8+ hrs', color: '#1a3c34' }
          ];
          const cellHeight = window.innerWidth <= 576 ? 16 : 20;
          const option = {
            tooltip: { position: 'top', formatter: (params) => `${params.data[0]}: ${params.data[1]} hours` },
            visualMap: {
              type: 'piecewise',
              pieces: pieces,
              orient: 'horizontal',
              left: 'center',
              top: 0,
              textStyle: { color: '#333', fontFamily: "'Inter', sans-serif" },
              calculable: true
            },
            calendar: {
              range: [startDate, endDate],
              cellSize: ['auto', cellHeight],
              orient: 'horizontal',
              itemStyle: { borderColor: '#fff' },
              splitLine: { show: true, lineStyle: { color: '#e9ecef', width: 1, type: 'solid' } },
              dayLabel: { nameMap: 'en', fontFamily: "'Inter', sans-serif" },
              monthLabel: { fontFamily: "'Inter', sans-serif" }
            },
            series: [{ type: 'heatmap', coordinateSystem: 'calendar', data: data, label: { show: false } }]
          };
          console.log("Heatmap option:", option);

          // Set chart options
          state.charts.calendarChart.setOption(option);
        } catch (error) {
          console.error("Error rendering heatmap:", error);
          elements.calendarHeatmap.innerHTML = `<p class="text-muted">Error rendering heatmap: ${error.message}. Please refresh.</p>`;
        }
      };

      const renderHeatmapStatsPie = (entries) => {
        if (!elements.heatmapStatsPie) {
          console.error("Heatmap Stats Pie canvas missing");
          return;
        }
        try {
          if (state.charts.heatmapStatsPie) state.charts.heatmapStatsPie.destroy();
          const hoursByDate = {};
          entries.forEach(e => {
            hoursByDate[e.date] = (hoursByDate[e.date] || 0) + e.hours;
          });
          const buckets = {
            zero: 0,
            zeroToTwo: 0,
            twoToFour: 0,
            fourToSix: 0,
            sixToEight: 0,
            eightPlus: 0
          };
          Object.values(hoursByDate).forEach(hours => {
            if (hours === 0) buckets.zero++;
            else if (hours <= 2) buckets.zeroToTwo++;
            else if (hours <= 4) buckets.twoToFour++;
            else if (hours <= 6) buckets.fourToSix++;
            else if (hours <= 8) buckets.sixToEight++;
            else buckets.eightPlus++;
          });
          const totalDays = Object.keys(hoursByDate).length;
          state.charts.heatmapStatsPie = new Chart(elements.heatmapStatsPie, {
            type: "pie",
            data: {
              labels: [
                `0 hrs: ${buckets.zero} (${Math.round((buckets.zero / totalDays) * 100)}%)`,
                `0-2 hrs: ${buckets.zeroToTwo} (${Math.round((buckets.zeroToTwo / totalDays) * 100)}%)`,
                `2-4 hrs: ${buckets.twoToFour} (${Math.round((buckets.twoToFour / totalDays) * 100)}%)`,
                `4-6 hrs: ${buckets.fourToSix} (${Math.round((buckets.fourToSix / totalDays) * 100)}%)`,
                `6-8 hrs: ${buckets.sixToEight} (${Math.round((buckets.sixToEight / totalDays) * 100)}%)`,
                `8+ hrs: ${buckets.eightPlus} (${Math.round((buckets.eightPlus / totalDays) * 100)}%)`
              ],
              datasets: [{
                data: [
                  buckets.zero,
                  buckets.zeroToTwo,
                  buckets.twoToFour,
                  buckets.fourToSix,
                  buckets.sixToEight,
                  buckets.eightPlus
                ],
                backgroundColor: ['#dc3545', '#e6f3ff', '#b3d9ff', '#80bfff', '#4d94ff', '#1a3c34']
              }]
            },
            options: {
              plugins: {
                legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } },
                title: { display: true, text: "Hours Distribution per Day", font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
              }
            }
          });
        } catch (error) {
          console.error("Error rendering heatmap stats pie:", error);
          elements.heatmapStatsPie.parentElement.innerHTML = `<p class="text-muted">Error rendering pie chart. Please refresh.</p>`;
        }
      };

      const setupEventListeners = () => {
        elements.toggleTableBtn.addEventListener("click", () => {
          const isHidden = elements.tableContainer.style.display === "none";
          elements.tableContainer.style.display = isHidden ? "block" : "none";
          elements.toggleTableBtn.setAttribute("title", isHidden ? "Hide Table" : "Show Table");
          elements.toggleTableBtn.setAttribute("aria-label", isHidden ? "Hide Table" : "Show Table");
        });

        elements.addBtn.addEventListener("click", async () => {
          const date = elements.newDateInput.value;
          const hours = parseFloat(elements.newHoursInput.value);
          if (!date || isNaN(hours) || hours < 0) {
            showError("Invalid date or hours");
            return;
          }
          try {
            await db.ref("entries").push({ date, hours });
            elements.newDateInput.value = "";
            elements.newHoursInput.value = "";
            elements.newDateInput.classList.add("highlight");
            elements.newHoursInput.classList.add("highlight");
            clearError();
          } catch (error) {
            console.error("Error adding entry:", error);
            showError("Error adding entry");
          }
        });

        elements.entriesTable.addEventListener("change", async (e) => {
          if (e.target.classList.contains("date-field") || e.target.classList.contains("hours-field")) {
            const row = e.target.closest("tr");
            const id = row.dataset.id;
            const date = row.querySelector(".date-field").value;
            const hours = parseFloat(row.querySelector(".hours-field").value);
            if (!date || isNaN(hours) || hours < 0) {
              showError("Invalid date or hours");
              return;
            }
            try {
              await db.ref(`entries/${id}`).update({ date, hours });
              row.classList.add("highlight");
              clearError();
            } catch (error) {
              console.error("Error updating entry:", error);
              showError("Error updating entry");
            }
          }
        });

        elements.entriesTable.addEventListener("click", async (e) => {
          if (e.target.classList.contains("delete-btn")) {
            if (!confirm("Are you sure you want to delete this entry?")) return;
            const id = e.target.closest("tr").dataset.id;
            try {
              await db.ref(`entries/${id}`).remove();
              clearError();
            } catch (error) {
              console.error("Error deleting entry:", error);
              showError("Error deleting entry");
            }
          }
        });

        elements.exportCsvBtn.addEventListener("click", () => {
          const csv = ["Date,Hours"];
          state.allEntries.forEach(entry => csv.push(`${entry.date},${entry.hours}`));
          const blob = new Blob([csv.join("\n")], { type: "text/csv" });
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "work_hours.csv";
          a.click();
          URL.revokeObjectURL(url);
        });

        elements.exportExcelBtn.addEventListener("click", () => {
          const ws = XLSX.utils.json_to_sheet(state.allEntries.map(e => ({ Date: e.date, Hours: e.hours })));
          const wb = XLSX.utils.book_new();
          XLSX.utils.book_append_sheet(wb, ws, "Work Hours");
          XLSX.writeFile(wb, "work_hours.xlsx");
        });

        elements.maximizeCalendarBtn.addEventListener("click", () => {
          elements.calendarHeatmap.style.height = "80vh";
          if (state.charts.calendarChart) state.charts.calendarChart.resize();
        });

        elements.minimizeCalendarBtn.addEventListener("click", () => {
          elements.calendarHeatmap.style.height = "";
          if (state.charts.calendarChart) state.charts.calendarChart.resize();
        });

        elements.maximizeHeatmapStatsBtn.addEventListener("click", () => {
          elements.heatmapStatsPie.style.height = "80vh";
          if (state.charts.heatmapStatsPie) state.charts.heatmapStatsPie.resize();
        });

        elements.minimizeHeatmapStatsBtn.addEventListener("click", () => {
          elements.heatmapStatsPie.style.height = "";
          if (state.charts.heatmapStatsPie) state.charts.heatmapStatsPie.resize();
        });

        elements.maximizeWeeklyTrendBtn.addEventListener("click", () => {
          elements.weeklyTrendChart.style.height = "80vh";
          if (state.charts.weeklyTrendChart) state.charts.weeklyTrendChart.resize();
        });

        elements.minimizeWeeklyTrendBtn.addEventListener("click", () => {
          elements.weeklyTrendChart.style.height = "";
          if (state.charts.weeklyTrendChart) state.charts.weeklyTrendChart.resize();
        });

        document.querySelectorAll(".info-icon").forEach(icon => {
          new bootstrap.Tooltip(icon);
          icon.addEventListener("click", () => {
            elements.infoModalBody.textContent = icon.dataset.description;
            new bootstrap.Modal(document.getElementById("infoModal")).show();
          });
        });

        window.addEventListener("resize", () => {
          Object.values(state.charts).forEach(chart => {
            if (chart && typeof chart.resize === 'function') chart.resize();
          });
        });
      };

      const init = () => {
        try {
          if (!elements.entriesTable || !elements.weeklyTrendChart || !elements.calendarHeatmap || !elements.heatmapStatsPie) {
            console.error("Critical DOM elements missing");
            elements.fallbackMessage.textContent = "Page rendering error. Please check your browser or refresh.";
            elements.fallbackMessage.style.display = "block";
            elements.loadingSpinner.style.display = "none";
            return;
          }
          initializeFirebase();
          loadEntries();
          setupEventListeners();
        } catch (error) {
          console.error("Initialization failed:", error);
          elements.fallbackMessage.textContent = "Failed to initialize the application. Please refresh the page.";
          elements.fallbackMessage.style.display = "block";
          elements.loadingSpinner.style.display = "none";
        }
      };

      document.addEventListener("DOMContentLoaded", init);
    </script>
</body>
</html>
