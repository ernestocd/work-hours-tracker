<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row =>
                    row.some(cell => cell !== '' && cell !== null && cell !== undefined)
                );

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Work Hours Tracker - Workweek Statistics</title>
  <link rel="apple-touch-icon" sizes="180x180" href="img/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="img/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="img/favicon-16x16.png">
  <link rel="manifest" href="img/site.webmanifest">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@1.4.0"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5.5.1/dist/echarts.min.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #f5f7fa;
      padding: 1.5rem;
      color: #333;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 600;
      color: #1a3c34;
      margin-bottom: 1.5rem;
    }
    h5 {
      font-size: 1.1rem;
      font-weight: 500;
      color: #1a3c34;
      margin-bottom: 1rem;
    }
    .stat-box {
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .stat-box:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .table-container {
      max-height: 300px;
      overflow-y: auto;
      margin-bottom: 2rem;
      display: none;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1rem;
    }
    .table th, .table td {
      vertical-align: middle;
      padding: 0.75rem;
    }
    .table thead {
      background: #f8f9fa;
      position: sticky;
      top: 0;
      z-index: 1;
    }
    .table tbody tr:nth-child(even) {
      background: #f9fbfc;
    }
    .highlight {
      animation: highlight 1s ease-out;
    }
    @keyframes highlight {
      0% { background-color: #e6ffed; }
      100% { background-color: transparent; }
    }
    .editable:hover {
      background-color: #f1f3f5;
      cursor: pointer;
    }
    .btn-sm {
      padding: 0.35rem 0.75rem;
      font-size: 0.875rem;
    }
    #calendar-heatmap, #weekly-bar-chart, #trend-line-chart {
      height: 350px;
      width: 100%;
    }
    #heatmap-stats-pie, #worked-vs-not-worked-chart, #real-world-comparison-chart {
      height: 250px;
      width: 100%;
    }
    .chart-container {
      position: relative;
      border-radius: 10px;
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 1.5rem;
      margin-bottom: 1.5rem;
    }
    .chart-maximized {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      z-index: 1000;
      background: white;
      padding: 1.5rem;
      margin: 0;
    }
    .chart-maximized #calendar-heatmap,
    .chart-maximized #weekly-bar-chart,
    .chart-maximized #trend-line-chart,
    .chart-maximized #heatmap-stats-pie {
      height: calc(100vh - 120px);
      width: 100%;
    }
    .chart-maximized .maximize-btn { display: none; }
    .chart-maximized .minimize-btn { display: block; }
    .chart-maximized .rotate-btn { display: block; }
    .minimize-btn, .rotate-btn {
      display: none;
      position: fixed;
      z-index: 1001;
    }
    .minimize-btn {
      top: 15px;
      right: 15px;
    }
    .rotate-btn {
      top: 55px;
      right: 15px;
    }
    .filter-sticky {
      position: sticky;
      top: 0;
      z-index: 999;
      background: white;
      padding: 0.75rem;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      margin-bottom: 1.5rem;
    }
    .filter-sticky .row { align-items: center; }
    .filter-sticky .form-control {
      height: 2.25rem;
      font-size: 0.875rem;
      border-radius: 8px;
      border: 1px solid #ced4da;
      transition: border-color 0.2s ease;
      width: 100%;
    }
    .filter-sticky .form-control:focus {
      border-color: #1a3c34;
      box-shadow: 0 0 0 2px rgba(26, 60, 52, 0.1);
    }
    .week-nav-btn, .action-btn {
      width: 2.25rem;
      height: 2.25rem;
      padding: 0;
      font-size: 0.875rem;
      border-radius: 8px;
      border: 1px solid #ced4da;
      transition: background-color 0.2s ease, transform 0.2s ease;
      background-color: #fff;
    }
    .week-nav-btn:hover, .action-btn:hover {
      background-color: #e9ecef;
      transform: scale(1.05);
    }
    .week-nav-btn {
      font-size: 1.2rem;
      font-weight: bold;
      color: #1a3c34;
      line-height: 1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .stat-box p {
      font-size: 0.875rem;
      color: #555;
      margin-bottom: 0.5rem;
    }
    .stat-box strong {
      color: #1a3c34;
    }
    .progress {
      height: 0.5rem;
      border-radius: 5px;
      background: #e9ecef;
    }
    .progress-bar {
      background: #1a3c34;
    }
    .btn-outline-secondary {
      border-color: #ced4da;
      color: #555;
    }
    .btn-outline-secondary:hover {
      background-color: #f1f3f5;
      color: #1a3c34;
    }
    .error-message {
      color: #dc3545;
      background: #f8d7da;
      padding: 0.5rem;
      border-radius: 5px;
      font-size: 0.875rem;
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #1a3c34;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
      margin: 1rem auto;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .navbar {
      background: white;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      padding: 0.5rem 1.5rem;
      margin-bottom: 1.5rem;
    }
    .navbar .nav-link {
      color: #1a3c34;
      font-weight: 500;
      margin-right: 1rem;
    }
    .navbar .nav-link.active {
      color: #1a3c34;
      font-weight: 600;
      border-bottom: 2px solid #1a3c34;
    }
    @media (max-width: 576px) {
      body { padding: 1rem; }
      h1 { font-size: 1.5rem; }
      h5 { font-size: 1rem; }
      .stat-box { padding: 1rem; }
      .chart-container { padding: 1rem; }
      .btn-sm { font-size: 0.75rem; }
      #calendar-heatmap, #weekly-bar-chart, #trend-line-chart { height: 300px; }
      #heatmap-stats-pie, #worked-vs-not-worked-chart, #real-world-comparison-chart { height: 200px; }
      .chart-maximized { padding: 1rem; }
      .chart-maximized #calendar-heatmap,
      .chart-maximized #weekly-bar-chart,
      .chart-maximized #trend-line-chart,
      .chart-maximized #heatmap-stats-pie {
        height: calc(100vh - 100px);
      }
      .filter-sticky { padding: 0.5rem; }
      .filter-sticky .row > div { margin-bottom: 0.5rem; }
      .filter-sticky .form-control {
        height: 2rem;
        font-size: 0.85rem;
      }
      .filter-sticky .date-input-col {
        flex: 0 0 100%;
        max-width: 100%;
      }
      .week-nav-btn, .action-btn {
        width: 2rem;
        height: 2rem;
        font-size: 0.9rem;
        margin: 0.25rem;
      }
      .week-nav-btn {
        font-size: 1rem;
      }
      .filter-buttons-row {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        flex-wrap: wrap;
      }
      .date-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .date-input-wrapper {
        flex: 1;
      }
      .navbar { padding: 0.5rem; }
      .navbar .nav-link { margin-right: 0.5rem; font-size: 0.9rem; }
    }
    @media (min-width: 577px) {
      .filter-buttons-row {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
      }
      .filter-sticky .form-control {
        font-size: 0.9rem;
      }
      .date-row {
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }
      .date-input-wrapper {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-light">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">Work Hours Tracker</a>
      <div class="navbar-nav">
        <a class="nav-link active" href="workweek-stats.html">Workweek Statistics</a>
        <a class="nav-link" href="global-stats.html">Global Statistics</a>
      </div>
    </div>
  </nav>

  <div class="container">
    <h1 class="mb-3">📊 Workweek Statistics</h1>

    <div class="filter-sticky">
      <form id="filterForm">
        <div class="row g-2 align-items-center">
          <div class="col-12 col-md-6 date-input-col">
            <div class="date-row">
              <button type="button" id="prevWeekNavBtn" class="btn btn-outline-primary week-nav-btn" title="Previous Week" aria-label="Previous Week">←</button>
              <div class="date-input-wrapper">
                <input type="date" id="startDate" class="form-control" placeholder="Start Date" aria-label="Start Date" />
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 date-input-col">
            <div class="date-row">
              <div class="date-input-wrapper">
                <input type="date" id="endDate" class="form-control" placeholder="End Date" aria-label="End Date" />
              </div>
              <button type="button" id="nextWeekNavBtn" class="btn btn-outline-primary week-nav-btn" title="Next Week" aria-label="Next Week">→</button>
            </div>
          </div>
          <div class="col-12 filter-buttons-row">
            <button type="button" id="currentWeekBtn" class="btn btn-outline-primary action-btn" title="Show Current Workweek" aria-label="Show Current Workweek">📅</button>
            <button type="button" id="toggleTableBtn" class="btn btn-outline-primary action-btn" title="Show/Hide Table" aria-label="Show/Hide Table">📋</button>
          </div>
        </div>
      </form>
    </div>

    <div class="loading-spinner" id="loadingSpinner"></div>

    <div class="table-container" id="tableContainer">
      <table class="table table-bordered table-hover">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Hours</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="entriesTable">
          <tr id="addRow">
            <td><input type="date" id="newDate" class="form-control" aria-label="New Date" /></td>
            <td><input type="number" id="newHours" class="form-control" step="0.1" min="0" placeholder="Hours" aria-label="New Hours" /></td>
            <td><button id="addBtn" class="btn btn-success btn-sm">Add New</button></td>
          </tr>
        </tbody>
      </table>
      <div class="mb-3">
        <button id="exportCsvBtn" class="btn btn-outline-primary btn-sm me-2">Export to CSV</button>
        <button id="exportExcelBtn" class="btn btn-outline-primary btn-sm">Export to Excel</button>
      </div>
    </div>

    <div class="row">
      <div class="col-md-4 stat-box">
        <h5>Selected Workweek</h5>
        <p><strong id="thisWeekHours">0</strong> / <span id="expectedHours">40</span> hrs (<span id="weeksCount">1</span> weeks)</p>
        <div class="progress mb-2">
          <div id="weekProgress" class="progress-bar" role="progressbar" style="width: 0%;"></div>
        </div>
        <p id="weekStatus" class="text-muted small"></p>
        <canvas id="donutChart"></canvas>
      </div>

      <div class="col-md-4 stat-box">
        <h5>Workweek Insights</h5>
        <p>Total Hours: <strong id="globalTotal">0</strong></p>
        <p>Weeks Tracked: <strong id="weeksTracked">0</strong></p>
        <p>Avg/Week: <strong id="globalAvg">0</strong></p>
        <p>Successful Weeks: <strong id="goalWeeks">0</strong></p>
        <p>Days Worked: <strong id="daysWorked">0/7</strong></p>
        <canvas id="worked-vs-not-worked-chart"></canvas>
      </div>

      <div class="col-md-4 stat-box">
        <h5>Real-World Comparison</h5>
        <p>Avg vs Full-Time: <strong id="avgVsFullTime">0%</strong></p>
        <p>Classification: <strong id="classification">N/A</strong></p>
        <p>Attendance: <strong id="attendancePercent">0%</strong></p>
        <p class="text-muted small" id="realWorldMessage"></p>
        <canvas id="real-world-comparison-chart"></canvas>
      </div>

      <div class="col-md-4 stat-box">
        <h5>Daily Insights</h5>
        <p>Longest Day: <strong id="maxDay">0 hrs</strong></p>
        <p>Avg/Day: <strong id="avgDay">0</strong></p>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 chart-container" id="weeklyBarContainer">
        <h5>Weekly Hours Distribution</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeWeeklyBarBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeWeeklyBarBtn" aria-label="Minimize Chart">Minimize</button>
        <button class="btn btn-outline-secondary btn-sm rotate-btn" id="rotateWeeklyBarBtn" aria-label="Rotate Chart">Rotate</button>
        <canvas id="weeklyBarChart"></canvas>
      </div>
      <div class="col-md-6 chart-container" id="trendLineContainer">
        <h5>Weekly Hours Trend</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeTrendLineBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeTrendLineBtn" aria-label="Minimize Chart">Minimize</button>
        <button class="btn btn-outline-secondary btn-sm rotate-btn" id="rotateTrendLineBtn" aria-label="Rotate Chart">Rotate</button>
        <canvas id="trendLineChart"></canvas>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-6 chart-container" id="calendarContainer">
        <h5>Calendar Heatmap</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeCalendarBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeCalendarBtn" aria-label="Minimize Chart">Minimize</button>
        <button class="btn btn-outline-secondary btn-sm rotate-btn" id="rotateCalendarBtn" aria-label="Rotate Chart">Rotate</button>
        <div id="calendar-heatmap"></div>
      </div>
      <div class="col-md-6 chart-container" id="heatmapStatsContainer">
        <h5>Heatmap Statistics (Days)</h5>
        <button class="btn btn-outline-secondary btn-sm maximize-btn" id="maximizeHeatmapStatsBtn" aria-label="Maximize Chart">Maximize</button>
        <button class="btn btn-outline-secondary btn-sm minimize-btn" id="minimizeHeatmapStatsBtn" aria-label="Minimize Chart">Minimize</button>
        <button class="btn btn-outline-secondary btn-sm rotate-btn" id="rotateHeatmapStatsBtn" aria-label="Rotate Chart">Rotate</button>
        <canvas id="heatmap-stats-pie"></canvas>
      </div>
    </div>
  </div>

  <script>
    // State management
    const state = {
      allEntries: [],
      filteredEntries: [],
      charts: {
        donutChart: null,
        barChart: null,
        lineChart: null,
        calendarChart: null,
        heatmapStatsPie: null,
        workedVsNotWorkedChart: null,
        realWorldComparisonChart: null
      },
      rotationStates: {
        isCalendarRotated: false,
        isWeeklyBarRotated: false,
        isTrendLineRotated: false,
        isHeatmapStatsRotated: false
      }
    };

    // DOM elements
    const elements = {
      filterForm: document.getElementById("filterForm"),
      currentWeekBtn: document.getElementById("currentWeekBtn"),
      prevWeekNavBtn: document.getElementById("prevWeekNavBtn"),
      nextWeekNavBtn: document.getElementById("nextWeekNavBtn"),
      entriesTable: document.getElementById("entriesTable"),
      exportCsvBtn: document.getElementById("exportCsvBtn"),
      exportExcelBtn: document.getElementById("exportExcelBtn"),
      startDateInput: document.getElementById("startDate"),
      endDateInput: document.getElementById("endDate"),
      newDateInput: document.getElementById("newDate"),
      newHoursInput: document.getElementById("newHours"),
      addBtn: document.getElementById("addBtn"),
      toggleTableBtn: document.getElementById("toggleTableBtn"),
      tableContainer: document.getElementById("tableContainer"),
      thisWeekHours: document.getElementById("thisWeekHours"),
      expectedHours: document.getElementById("expectedHours"),
      weeksCount: document.getElementById("weeksCount"),
      weekProgress: document.getElementById("weekProgress"),
      weekStatus: document.getElementById("weekStatus"),
      globalTotal: document.getElementById("globalTotal"),
      weeksTracked: document.getElementById("weeksTracked"),
      globalAvg: document.getElementById("globalAvg"),
      goalWeeks: document.getElementById("goalWeeks"),
      daysWorked: document.getElementById("daysWorked"),
      maxDay: document.getElementById("maxDay"),
      avgDay: document.getElementById("avgDay"),
      avgVsFullTime: document.getElementById("avgVsFullTime"),
      classification: document.getElementById("classification"),
      attendancePercent: document.getElementById("attendancePercent"),
      realWorldMessage: document.getElementById("realWorldMessage"),
      donutChart: document.getElementById("donutChart"),
      weeklyBarChart: document.getElementById("weeklyBarChart"),
      trendLineChart: document.getElementById("trendLineChart"),
      calendarHeatmap: document.getElementById("calendar-heatmap"),
      calendarContainer: document.getElementById("calendarContainer"),
      maximizeCalendarBtn: document.getElementById("maximizeCalendarBtn"),
      minimizeCalendarBtn: document.getElementById("minimizeCalendarBtn"),
      rotateCalendarBtn: document.getElementById("rotateCalendarBtn"),
      heatmapStatsPie: document.getElementById("heatmap-stats-pie"),
      heatmapStatsContainer: document.getElementById("heatmapStatsContainer"),
      maximizeHeatmapStatsBtn: document.getElementById("maximizeHeatmapStatsBtn"),
      minimizeHeatmapStatsBtn: document.getElementById("minimizeHeatmapStatsBtn"),
      rotateHeatmapStatsBtn: document.getElementById("rotateHeatmapStatsBtn"),
      workedVsNotWorkedChart: document.getElementById("worked-vs-not-worked-chart"),
      realWorldComparisonChart: document.getElementById("real-world-comparison-chart"),
      weeklyBarContainer: document.getElementById("weeklyBarContainer"),
      maximizeWeeklyBarBtn: document.getElementById("maximizeWeeklyBarBtn"),
      minimizeWeeklyBarBtn: document.getElementById("minimizeWeeklyBarBtn"),
      rotateWeeklyBarBtn: document.getElementById("rotateWeeklyBarBtn"),
      trendLineContainer: document.getElementById("trendLineContainer"),
      maximizeTrendLineBtn: document.getElementById("maximizeTrendLineBtn"),
      minimizeTrendLineBtn: document.getElementById("minimizeTrendLineBtn"),
      rotateTrendLineBtn: document.getElementById("rotateTrendLineBtn"),
      loadingSpinner: document.getElementById("loadingSpinner")
    };

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAnujd0rgEBYUVly32YOsQNBnuOYzVw8u0",
      authDomain: "work-hours-tracker-f48a6.firebaseapp.com",
      databaseURL: "https://work-hours-tracker-f48a6-default-rtdb.firebaseio.com",
      projectId: "work-hours-tracker-f48a6",
      storageBucket: "work-hours-tracker-f48a6.appspot.com",
      messagingSenderId: "945814366512",
      appId: "1:945814366512:web:778a312b936701199940f5"
    };

    // Utility functions
    const getWeekStart = (date) => {
      const d = new Date(date);
      const dayOfWeek = d.getDay();
      const daysToLastSaturday = (dayOfWeek + 1) % 7;
      d.setDate(d.getDate() - daysToLastSaturday);
      d.setHours(0, 0, 0, 0);
      return d;
    };

    const formatDateForInput = (date) => date.toISOString().split("T")[0];

    const countWeeksInRange = (startDate, endDate) => {
      const start = getWeekStart(new Date(startDate));
      const end = getWeekStart(new Date(endDate));
      const diffTime = Math.abs(end - start);
      const diffWeeks = Math.floor(diffTime / (7 * 24 * 60 * 60 * 1000)) + 1;
      return Math.max(1, diffWeeks);
    };

    const showError = (message) => {
      elements.weekStatus.classList.add("error-message");
      elements.weekStatus.textContent = message;
      setTimeout(() => clearError(), 5000);
    };

    const clearError = () => {
      elements.weekStatus.classList.remove("error-message");
      elements.weekStatus.textContent = "";
    };

    // Firebase initialization
    let db;
    const initializeFirebase = () => {
      try {
        firebase.initializeApp(firebaseConfig);
        db = firebase.database();
        console.log("Firebase initialized successfully");
      } catch (error) {
        console.error("Firebase initialization failed:", error);
        showError("Failed to connect to database. Please check your internet connection.");
        elements.loadingSpinner.style.display = "none";
        throw error;
      }
    };

    // Data loading and validation
    const loadEntries = () => {
      elements.loadingSpinner.style.display = "block";
      db.ref("entries").on("value", (snapshot) => {
        try {
          const data = snapshot.val() || {};
          state.allEntries = Object.entries(data).map(([id, entry]) => {
            if (!entry || !entry.date || typeof entry.hours === "undefined") return null;
            const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
            if (!dateRegex.test(entry.date)) return null;
            const hours = parseFloat(entry.hours);
            if (isNaN(hours) || hours < 0) return null;
            return { id, date: entry.date, hours };
          }).filter(entry => entry !== null);

          state.filteredEntries = [...state.allEntries];
          setCurrentWorkweek();
          elements.loadingSpinner.style.display = "none";
        } catch (error) {
          console.error("Error loading entries:", error.message || error);
          showError("Error loading data. Please try refreshing the page.");
          elements.loadingSpinner.style.display = "none";
        }
      }, (error) => {
        console.error("Firebase database error:", error);
        showError("Failed to load data: Database error. Please check your connection.");
        elements.loadingSpinner.style.display = "none";
      });
    };

    // Table rendering
    const renderTable = (entries) => {
      const sortedEntries = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));
      const rows = sortedEntries.map(entry => `
        <tr data-id="${entry.id}">
          <td><input type="date" class="form-control editable date-field" value="${entry.date}" aria-label="Edit Date" /></td>
          <td><input type="number" class="form-control editable hours-field" value="${entry.hours}" step="0.1" min="0" aria-label="Edit Hours" /></td>
          <td><button class="btn btn-danger btn-sm delete-btn" aria-label="Delete Entry">🗑️</button></td>
        </tr>
      `).join("");
      elements.entriesTable.innerHTML = `
        <tr id="addRow">
          <td><input type="date" id="newDate" class="form-control" aria-label="New Date" /></td>
          <td><input type="number" id="newHours" class="form-control" step="0.1" min="0" placeholder="Hours" aria-label="New Hours" /></td>
          <td><button id="addBtn" class="btn btn-success btn-sm" aria-label="Add New Entry">Add New</button></td>
        </tr>
        ${rows}
      `;
    };

    // Update UI
    const updateUI = (entries) => {
      state.filteredEntries = entries;
      renderTable(entries);
      updateSelectedPeriodStats(entries);
      updateGlobalStats(entries);
      renderCalendarHeatmap(entries);
    };

    // Selected Period Stats
    const updateSelectedPeriodStats = (entries, startDate = null, endDate = null) => {
      const totalHours = entries.reduce((sum, e) => sum + e.hours, 0);
      let weeksInPeriod = 1;
      if (startDate && endDate) {
        const dates = entries.map(e => new Date(e.date));
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const selectedStart = new Date(startDate);
        const selectedEnd = new Date(endDate);
        if (selectedStart.getTime() === minDate.getTime() && selectedEnd.getTime() === maxDate.getTime()) {
          weeksInPeriod = countWeeksInRange(startDate, endDate);
        }
      }
      const expectedHours = weeksInPeriod * 40;

      elements.thisWeekHours.textContent = totalHours.toFixed(1);
      elements.expectedHours.textContent = expectedHours.toFixed(1);
      elements.weeksCount.textContent = weeksInPeriod;

      const percent = expectedHours > 0 ? Math.min(100, (totalHours / expectedHours) * 100) : 0;
      elements.weekProgress.style.width = `${percent}%`;
      let status = totalHours >= expectedHours
        ? "✅ Goal met!"
        : `❌ ${(expectedHours - totalHours).toFixed(1)} hrs short`;
      if (totalHours > expectedHours) {
        status = `➕ ${(totalHours - expectedHours).toFixed(1)} hrs over`;
      }
      elements.weekStatus.textContent = status;

      if (state.charts.donutChart) state.charts.donutChart.destroy();
      state.charts.donutChart = new Chart(elements.donutChart, {
        type: "doughnut",
        data: {
          labels: ["Worked", "Remaining"],
          datasets: [{ data: [totalHours, Math.max(0, expectedHours - totalHours)], backgroundColor: ["#1a3c34", "#e9ecef"] }]
        },
        options: {
          cutout: "75%",
          plugins: { legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } } }
        }
      });

      const dailyHours = Array(7).fill(0);
      entries.forEach(e => {
        const day = new Date(e.date).getDay();
        dailyHours[day] += e.hours;
      });
      if (state.charts.barChart) state.charts.barChart.destroy();
      state.charts.barChart = new Chart(elements.weeklyBarChart, {
        type: "bar",
        data: {
          labels: state.rotationStates.isWeeklyBarRotated ? dailyHours : ["Sat", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri"],
          datasets: [{ label: "Hours", data: state.rotationStates.isWeeklyBarRotated ? ["Sat", "Sun", "Mon", "Tue", "Wed", "Thu", "Fri"] : dailyHours, backgroundColor: "#1a3c34", axis: state.rotationStates.isWeeklyBarRotated ? "y" : "x" }]
        },
        options: {
          indexAxis: state.rotationStates.isWeeklyBarRotated ? "y" : "x",
          scales: {
            [state.rotationStates.isWeeklyBarRotated ? "x" : "y"]: { beginAtZero: true, ticks: { font: { family: "'Inter', sans-serif" } } },
            [state.rotationStates.isWeeklyBarRotated ? "y" : "x"]: { ticks: { font: { family: "'Inter', sans-serif" } } }
          },
          plugins: { legend: { labels: { font: { family: "'Inter', sans-serif" } } } }
        }
      });
    };

    // Global Stats
    const updateGlobalStats = (entries, startDate = null, endDate = null) => {
      const globalTotal = entries.reduce((sum, e) => sum + e.hours, 0);
      const weeks = {};
      const uniqueDays = new Set();
      entries.forEach(e => {
        const weekStart = getWeekStart(new Date(e.date)).toISOString().split("T")[0];
        weeks[weekStart] = (weeks[weekStart] || 0) + e.hours;
        if (e.hours > 0) uniqueDays.add(e.date);
      });

      let totalWeeks = 1;
      if (startDate && endDate) {
        const dates = entries.map(e => new Date(e.date));
        const minDate = new Date(Math.min(...dates));
        const maxDate = new Date(Math.max(...dates));
        const selectedStart = new Date(startDate);
        const selectedEnd = new Date(endDate);
        if (selectedStart.getTime() === minDate.getTime() && selectedEnd.getTime() === maxDate.getTime()) {
          totalWeeks = countWeeksInRange(startDate, endDate);
        }
      } else {
        totalWeeks = Object.keys(weeks).length || 1;
      }

      const totalPossibleDays = totalWeeks * 7;
      const daysWorked = uniqueDays.size;
      const avgWeek = totalWeeks > 0 ? globalTotal / totalWeeks : 0;
      const avgDay = uniqueDays.size > 0 ? globalTotal / uniqueDays.size : 0;
      const maxDay = entries.length > 0 ? Math.max(...entries.filter(e => e.hours > 0).map(e => e.hours), 0) : 0;
      const goalWeeks = Object.values(weeks).filter(hours => hours >= 40).length;

      elements.globalTotal.textContent = globalTotal.toFixed(1);
      elements.weeksTracked.textContent = totalWeeks;
      elements.globalAvg.textContent = avgWeek.toFixed(1);
      elements.avgDay.textContent = avgDay.toFixed(1);
      elements.maxDay.textContent = maxDay.toFixed(1);
      elements.goalWeeks.textContent = goalWeeks;
      elements.daysWorked.textContent = `${daysWorked}/${totalPossibleDays}`;

      const daysNotWorked = entries.filter(e => e.hours === 0).length;
      const daysWorkedCount = daysWorked;
      const totalEntries = entries.length;
      const workedPercent = totalEntries > 0 ? Math.round((daysWorkedCount / totalEntries) * 100) : 0;
      const notWorkedPercent = totalEntries > 0 ? Math.round((daysNotWorked / totalEntries) * 100) : 0;

      if (state.charts.workedVsNotWorkedChart) state.charts.workedVsNotWorkedChart.destroy();
      state.charts.workedVsNotWorkedChart = new Chart(elements.workedVsNotWorkedChart, {
        type: "doughnut",
        data: {
          labels: [`Worked Days: ${daysWorkedCount} (${workedPercent}%)`, `Not Worked Days: ${daysNotWorked} (${notWorkedPercent}%)`],
          datasets: [{ data: [daysWorkedCount, daysNotWorked], backgroundColor: ["#28a745", "#dc3545"] }]
        },
        options: {
          cutout: "75%",
          plugins: {
            legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } },
            title: { display: true, text: "Worked vs Not Worked Days", padding: { top: 10, bottom: 10 }, font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
          }
        }
      });

      const labels = Object.keys(weeks).sort();
      const data = labels.map(label => weeks[label]);
      if (state.charts.lineChart) state.charts.lineChart.destroy();
      state.charts.lineChart = new Chart(elements.trendLineChart, {
        type: "line",
        data: {
          labels: state.rotationStates.isTrendLineRotated ? data : labels,
          datasets: [{ label: "Weekly Hours", data: state.rotationStates.isTrendLineRotated ? labels : data, borderColor: "#1a3c34", fill: false, pointRadius: 4, pointBackgroundColor: "#1a3c34" }]
        },
        options: {
          indexAxis: state.rotationStates.isTrendLineRotated ? "y" : "x",
          plugins: {
            annotation: {
              annotations: {
                goalLine: {
                  type: "line",
                  [state.rotationStates.isTrendLineRotated ? "xMin" : "yMin"]: 40,
                  [state.rotationStates.isTrendLineRotated ? "xMax" : "yMax"]: 40,
                  borderColor: "red",
                  borderWidth: 2,
                  label: { content: "Goal (40 hrs)", enabled: true, position: "start", backgroundColor: "rgba(255, 99, 132, 0.8)", color: "white", font: { weight: "bold", family: "'Inter', sans-serif" } }
                }
              }
            },
            legend: { labels: { font: { family: "'Inter', sans-serif" } } }
          },
          scales: {
            [state.rotationStates.isTrendLineRotated ? "x" : "y"]: { beginAtZero: true, ticks: { font: { family: "'Inter', sans-serif" } } },
            [state.rotationStates.isTrendLineRotated ? "y" : "x"]: { ticks: { font: { family: "'Inter', sans-serif" } } }
          }
        }
      });

      const fullTimeHoursPerWeek = 40;
      const avgVsFullTimePercent = totalWeeks > 0 ? (avgWeek / fullTimeHoursPerWeek) * 100 : 0;
      let classification = "N/A";
      if (avgVsFullTimePercent >= 90) classification = "Excellent";
      else if (avgVsFullTimePercent >= 75) classification = "Adequate";
      else if (avgVsFullTimePercent >= 60) classification = "Below Average";
      else if (avgVsFullTimePercent >= 40) classification = "Inconsistent";
      else if (avgVsFullTimePercent >= 20) classification = "Minimal Effort";
      else if (avgVsFullTimePercent > 0) classification = "Negligible";

      const attendancePercent = totalEntries > 0 ? Math.round((daysWorkedCount / totalEntries) * 100) : 0;

      elements.avgVsFullTime.textContent = avgVsFullTimePercent.toFixed(1) + "%";
      elements.classification.textContent = classification;
      elements.attendancePercent.textContent = attendancePercent + "%";
      elements.realWorldMessage.textContent = `Over the last ${totalWeeks} weeks, you’ve averaged ${avgVsFullTimePercent.toFixed(1)}% of a full-time workload. You’ve missed ${(100 - attendancePercent)}% of your days—almost ${Math.round((100 - attendancePercent) / 100 * 7)} days per week. Only ${goalWeeks} out of ${totalWeeks} weeks met full-time expectations.`;

      if (state.charts.realWorldComparisonChart) state.charts.realWorldComparisonChart.destroy();
      state.charts.realWorldComparisonChart = new Chart(elements.realWorldComparisonChart, {
        type: "doughnut",
        data: {
          labels: [`Worked: ${avgVsFullTimePercent.toFixed(1)}%`, `Remaining: ${(100 - avgVsFullTimePercent).toFixed(1)}%`],
          datasets: [{ data: [avgVsFullTimePercent, 100 - avgVsFullTimePercent], backgroundColor: ["#1a3c34", "#e9ecef"] }]
        },
        options: {
          cutout: "75%",
          plugins: {
            legend: { position: "bottom", labels: { font: { size: 12, family: "'Inter', sans-serif" } } },
            title: { display: true, text: "Average vs Full-Time (40 hrs/week)", padding: { top: 10, bottom: 10 }, font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
          }
        }
      });
    };

    // Calendar Heatmap
    const renderCalendarHeatmap = (entries) => {
      if (typeof echarts === "undefined") {
        console.error("ECharts is not available. Skipping heatmap rendering.");
        elements.calendarHeatmap.innerHTML = `
          <p class="text-muted">
            Unable to load calendar heatmap. This feature requires an internet connection to load the ECharts library.
            Please ensure you're online and try refreshing the page.
          </p>
        `;
        return;
      }

      if (state.charts.calendarChart) state.charts.calendarChart.dispose();
      state.charts.calendarChart = echarts.init(elements.calendarHeatmap);

      const data = entries.map(entry => [entry.date, entry.hours]);
      const maxHours = entries.length > 0 ? Math.max(...entries.map(entry => entry.hours)) : 10;
      const maxValue = Math.ceil(maxHours);

      const endDate = new Date();
      const startDate = new Date();
      startDate.setMonth(startDate.getMonth() - 6);

      const pieces = [
        { value: 0, label: '0 hrs (No Work)', color: '#dc3545' },
        { min: 0, max: 2, label: '0-2 hrs', color: '#e6f3ff' },
        { min: 2, max: 4, label: '2-4 hrs', color: '#b3d9ff' },
        { min: 4, max: 6, label: '4-6 hrs', color: '#80bfff' },
        { min: 6, max: 8, label: '6-8 hrs', color: '#4d94ff' },
        { min: 8, label: '8+ hrs', color: '#1a3c34' }
      ];

      const isMaximized = elements.calendarContainer.classList.contains("chart-maximized");
      const cellHeight = isMaximized ? (window.innerWidth <= 576 ? 20 : 30) : (window.innerWidth <= 576 ? 16 : 20);

      const option = {
        tooltip: { position: 'top', formatter: (params) => `${params.data[0]}: ${params.data[1]} hours` },
        visualMap: {
          type: 'piecewise',
          pieces: pieces,
          orient: state.rotationStates.isCalendarRotated ? 'vertical' : 'horizontal',
          left: state.rotationStates.isCalendarRotated ? 'right' : 'center',
          top: state.rotationStates.isCalendarRotated ? 'center' : 0,
          textStyle: { color: '#333', fontFamily: "'Inter', sans-serif" },
          calculable: true
        },
        calendar: {
          range: [startDate, endDate],
          cellSize: state.rotationStates.isCalendarRotated ? [cellHeight, 'auto'] : ['auto', cellHeight],
          orient: state.rotationStates.isCalendarRotated ? 'vertical' : 'horizontal',
          itemStyle: { borderColor: '#fff' },
          splitLine: { show: true, lineStyle: { color: '#e9ecef', width: 1, type: 'solid' } },
          dayLabel: { nameMap: 'en', fontFamily: "'Inter', sans-serif" },
          monthLabel: { fontFamily: "'Inter', sans-serif" }
        },
        series: [{ type: 'heatmap', coordinateSystem: 'calendar', data: data, label: { show: false } }]
      };

      try {
        state.charts.calendarChart.setOption(option);
      } catch (error) {
        console.error("Error rendering ECharts calendar heatmap:", error);
        elements.calendarHeatmap.innerHTML = `
          <p class="text-muted">
            Error rendering calendar heatmap. Please try refreshing the page or check your internet connection.
          </p>
        `;
      }

      const stats = { zero: 0, zeroToTwo: 0, twoToFour: 0, fourToSix: 0, sixToEight: 0, eightPlus: 0 };
      entries.forEach(entry => {
        const hours = entry.hours;
        if (hours === 0) stats.zero++;
        else if (hours > 0 && hours <= 2) stats.zeroToTwo++;
        else if (hours > 2 && hours <= 4) stats.twoToFour++;
        else if (hours > 4 && hours <= 6) stats.fourToSix++;
        else if (hours > 6 && hours <= 8) stats.sixToEight++;
        else if (hours > 8) stats.eightPlus++;
      });

      const totalEntries = entries.length;
      const zeroPercent = totalEntries > 0 ? Math.round((stats.zero / totalEntries) * 100) : 0;
      const zeroToTwoPercent = totalEntries > 0 ? Math.round((stats.zeroToTwo / totalEntries) * 100) : 0;
      const twoToFourPercent = totalEntries > 0 ? Math.round((stats.twoToFour / totalEntries) * 100) : 0;
      const fourToSixPercent = totalEntries > 0 ? Math.round((stats.fourToSix / totalEntries) * 100) : 0;
      const sixToEightPercent = totalEntries > 0 ? Math.round((stats.sixToEight / totalEntries) * 100) : 0;
      const eightPlusPercent = totalEntries > 0 ? Math.round((stats.eightPlus / totalEntries) * 100) : 0;

      if (state.charts.heatmapStatsPie) state.charts.heatmapStatsPie.destroy();
      state.charts.heatmapStatsPie = new Chart(elements.heatmapStatsPie, {
        type: state.rotationStates.isHeatmapStatsRotated ? 'bar' : 'pie',
        data: {
          labels: [
            `0 hrs (No Work): ${stats.zero} (${zeroPercent}%)`,
            `0-2 hrs: ${stats.zeroToTwo} (${zeroToTwoPercent}%)`,
            `2-4 hrs: ${stats.twoToFour} (${twoToFourPercent}%)`,
            `4-6 hrs: ${stats.fourToSix} (${fourToSixPercent}%)`,
            `6-8 hrs: ${stats.sixToEight} (${sixToEightPercent}%)`,
            `8+ hrs: ${stats.eightPlus} (${eightPlusPercent}%)`
          ],
          datasets: [{ label: state.rotationStates.isHeatmapStatsRotated ? 'Days' : undefined, data: [stats.zero, stats.zeroToTwo, stats.twoToFour, stats.fourToSix, stats.sixToEight, stats.eightPlus], backgroundColor: ['#dc3545', '#e6f3ff', '#b3d9ff', '#80bfff', '#4d94ff', '#1a3c34'] }]
        },
        options: {
          indexAxis: state.rotationStates.isHeatmapStatsRotated ? 'y' : undefined,
          plugins: {
            legend: { position: state.rotationStates.isHeatmapStatsRotated ? 'right' : 'bottom', labels: { boxWidth: 12, font: { size: 12, family: "'Inter', sans-serif" } } },
            title: { display: true, text: 'Heatmap Statistics (Days)', padding: { top: 10, bottom: 10 }, font: { size: 14, family: "'Inter', sans-serif", weight: "500" } }
          },
          scales: state.rotationStates.isHeatmapStatsRotated ? { x: { beginAtZero: true, ticks: { font: { family: "'Inter', sans-serif" } } }, y: { ticks: { autoSkip: false, font: { family: "'Inter', sans-serif" } } } } : undefined
        }
      });
    };

    // Date filtering
    const applyDateFilter = (startDateValue, endDateValue) => {
      if (!startDateValue || !endDateValue) {
        showError("Please select both dates");
        return;
      }

      const start = new Date(startDateValue);
      const end = new Date(endDateValue);
      end.setHours(23, 59, 59, 999);
      if (start > end) {
        showError("Start date must be before end date");
        return;
      }

      const filtered = state.allEntries.filter(e => {
        const date = new Date(e.date);
        return date >= start && date <= end;
      });
      updateUI(filtered);
      updateSelectedPeriodStats(filtered, start, end);
      updateGlobalStats(filtered, start, end);
    };

    const setInitialDateRange = (entries) => {
      setCurrentWorkweek();
    };

    // Custom Saturday-Friday workweek functions
    const setCurrentWorkweek = () => {
      const today = new Date();
      const dayOfWeek = today.getDay();
      const daysToLastSaturday = (dayOfWeek + 1) % 7;
      const startDate = new Date(today);
      startDate.setDate(today.getDate() - daysToLastSaturday);
      startDate.setHours(0, 0, 0, 0);
      const endDate = new Date(startDate);
      endDate.setDate(startDate.getDate() + 6);
      setDatePickerValues(startDate, endDate);
      applyDateFilter(elements.startDateInput.value, elements.endDateInput.value);
    };

    const setDatePickerValues = (startDate, endDate) => {
      elements.startDateInput.value = formatDateForInput(startDate);
      elements.endDateInput.value = formatDateForInput(endDate);
    };

    const navigateWeek = (direction) => {
      const currentStartDate = new Date(elements.startDateInput.value + 'T00:00:00');
      const newStartDate = new Date(currentStartDate);
      newStartDate.setDate(currentStartDate.getDate() + direction * 7);
      newStartDate.setHours(0, 0, 0, 0);
      const newEndDate = new Date(newStartDate);
      newEndDate.setDate(newStartDate.getDate() + 6);
      setDatePickerValues(newStartDate, newEndDate);
      applyDateFilter(elements.startDateInput.value, elements.endDateInput.value);
    };

    // Event handlers
    const setupEventListeners = () => {
      elements.startDateInput.addEventListener("change", () => {
        const fromDate = new Date(elements.startDateInput.value + 'T00:00:00');
        if (isNaN(fromDate.getTime())) {
          showError("Invalid start date");
          return;
        }
        const toDate = new Date(fromDate);
        toDate.setDate(fromDate.getDate() + 6);
        elements.endDateInput.value = formatDateForInput(toDate);
        applyDateFilter(elements.startDateInput.value, elements.endDateInput.value);
      });

      elements.endDateInput.addEventListener("change", () => {
        const toDate = new Date(elements.endDateInput.value + 'T00:00:00');
        if (isNaN(toDate.getTime())) {
          showError("Invalid end date");
          return;
        }
        const fromDate = new Date(toDate);
        fromDate.setDate(toDate.getDate() - 6);
        elements.startDateInput.value = formatDateForInput(fromDate);
        applyDateFilter(elements.startDateInput.value, elements.endDateInput.value);
      });

      elements.toggleTableBtn.addEventListener("click", () => {
        const isHidden = elements.tableContainer.style.display === "none";
        elements.tableContainer.style.display = isHidden ? "block" : "none";
        elements.toggleTableBtn.setAttribute("title", isHidden ? "Hide Table" : "Show Table");
        elements.toggleTableBtn.setAttribute("aria-label", isHidden ? "Hide Table" : "Show Table");
      });

      elements.addBtn.addEventListener("click", async () => {
        const date = elements.newDateInput.value;
        const hours = parseFloat(elements.newHoursInput.value);
        if (!date || isNaN(hours) || hours < 0) {
          showError("Invalid date or hours");
          return;
        }
        try {
          await db.ref("entries").push({ date, hours });
          elements.newDateInput.value = "";
          elements.newHoursInput.value = "";
          elements.newDateInput.classList.add("highlight");
          elements.newHoursInput.classList.add("highlight");
          clearError();
        } catch (error) {
          console.error("Error adding entry:", error);
          showError("Error adding entry");
        }
      });

      elements.entriesTable.addEventListener("change", async (e) => {
        if (e.target.classList.contains("date-field") || e.target.classList.contains("hours-field")) {
          const row = e.target.closest("tr");
          const id = row.dataset.id;
          const date = row.querySelector(".date-field").value;
          const hours = parseFloat(row.querySelector(".hours-field").value);
          if (!date || isNaN(hours) || hours < 0) {
            showError("Invalid date or hours");
            return;
          }
          try {
            await db.ref(`entries/${id}`).update({ date, hours });
            row.classList.add("highlight");
            clearError();
          } catch (error) {
            console.error("Error updating entry:", error);
            showError("Error updating entry");
          }
        }
      });

      elements.entriesTable.addEventListener("click", async (e) => {
        if (e.target.classList.contains("delete-btn")) {
          if (!confirm("Are you sure you want to delete this entry?")) return;
          const id = e.target.closest("tr").dataset.id;
          try {
            await db.ref(`entries/${id}`).remove();
            clearError();
          } catch (error) {
            console.error("Error deleting entry:", error);
            showError("Error deleting entry");
          }
        }
      });

      elements.currentWeekBtn.addEventListener("click", () => setCurrentWorkweek());
      elements.prevWeekNavBtn.addEventListener("click", () => navigateWeek(-1));
      elements.nextWeekNavBtn.addEventListener("click", () => navigateWeek(1));
      elements.exportCsvBtn.addEventListener("click", () => {
        const csv = ["Date,Hours"];
        state.filteredEntries.forEach(entry => csv.push(`${entry.date},${entry.hours}`));
        const blob = new Blob([csv.join("\n")], { type: "text/csv" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url;
        a.download = "work_hours.csv";
        a.click();
        URL.revokeObjectURL(url);
      });
      elements.exportExcelBtn.addEventListener("click", () => {
        const ws = XLSX.utils.json_to_sheet(state.filteredEntries.map(e => ({ Date: e.date, Hours: e.hours })));
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Work Hours");
        XLSX.writeFile(wb, "work_hours.xlsx");
      });

      elements.maximizeCalendarBtn.addEventListener("click", () => {
        elements.calendarContainer.classList.add("chart-maximized");
        if (state.charts.calendarChart) setTimeout(() => state.charts.calendarChart.resize(), 100);
      });
      elements.minimizeCalendarBtn.addEventListener("click", () => {
        elements.calendarContainer.classList.remove("chart-maximized");
        if (state.charts.calendarChart) setTimeout(() => state.charts.calendarChart.resize(), 100);
      });
      elements.rotateCalendarBtn.addEventListener("click", () => {
        state.rotationStates.isCalendarRotated = !state.rotationStates.isCalendarRotated;
        if (!elements.calendarContainer.classList.contains("chart-maximized")) elements.calendarContainer.classList.add("chart-maximized");
        renderCalendarHeatmap(state.filteredEntries);
        if (state.charts.calendarChart) setTimeout(() => state.charts.calendarChart.resize(), 100);
      });
      elements.maximizeHeatmapStatsBtn.addEventListener("click", () => {
        elements.heatmapStatsContainer.classList.add("chart-maximized");
        if (state.charts.heatmapStatsPie) setTimeout(() => state.charts.heatmapStatsPie.resize(), 100);
      });
      elements.minimizeHeatmapStatsBtn.addEventListener("click", () => {
        elements.heatmapStatsContainer.classList.remove("chart-maximized");
        if (state.charts.heatmapStatsPie) setTimeout(() => state.charts.heatmapStatsPie.resize(), 100);
      });
      elements.rotateHeatmapStatsBtn.addEventListener("click", () => {
        state.rotationStates.isHeatmapStatsRotated = !state.rotationStates.isHeatmapStatsRotated;
        if (!elements.heatmapStatsContainer.classList.contains("chart-maximized")) elements.heatmapStatsContainer.classList.add("chart-maximized");
        renderCalendarHeatmap(state.filteredEntries);
        if (state.charts.heatmapStatsPie) setTimeout(() => state.charts.heatmapStatsPie.resize(), 100);
      });
      elements.maximizeWeeklyBarBtn.addEventListener("click", () => {
        elements.weeklyBarContainer.classList.add("chart-maximized");
        if (state.charts.barChart) setTimeout(() => state.charts.barChart.resize(), 100);
      });
      elements.minimizeWeeklyBarBtn.addEventListener("click", () => {
        elements.weeklyBarContainer.classList.remove("chart-maximized");
        if (state.charts.barChart) setTimeout(() => state.charts.barChart.resize(), 100);
      });
      elements.rotateWeeklyBarBtn.addEventListener("click", () => {
        state.rotationStates.isWeeklyBarRotated = !state.rotationStates.isWeeklyBarRotated;
        if (!elements.weeklyBarContainer.classList.contains("chart-maximized")) elements.weeklyBarContainer.classList.add("chart-maximized");
        updateSelectedPeriodStats(state.filteredEntries);
        if (state.charts.barChart) setTimeout(() => state.charts.barChart.resize(), 100);
      });
      elements.maximizeTrendLineBtn.addEventListener("click", () => {
        elements.trendLineContainer.classList.add("chart-maximized");
        if (state.charts.lineChart) setTimeout(() => state.charts.lineChart.resize(), 100);
      });
      elements.minimizeTrendLineBtn.addEventListener("click", () => {
        elements.trendLineContainer.classList.remove("chart-maximized");
        if (state.charts.lineChart) setTimeout(() => state.charts.lineChart.resize(), 100);
      });
      elements.rotateTrendLineBtn.addEventListener("click", () => {
        state.rotationStates.isTrendLineRotated = !state.rotationStates.isTrendLineRotated;
        if (!elements.trendLineContainer.classList.contains("chart-maximized")) elements.trendLineContainer.classList.add("chart-maximized");
        updateGlobalStats(state.filteredEntries);
        if (state.charts.lineChart) setTimeout(() => state.charts.lineChart.resize(), 100);
      });

      window.addEventListener("resize", () => {
        Object.values(state.charts).forEach(chart => {
          if (chart && typeof chart.resize === 'function') chart.resize();
        });
      });
    };

    // Initialize the app
    const init = () => {
      try {
        initializeFirebase();
        loadEntries();
        setupEventListeners();
      } catch (error) {
        console.error("Initialization failed:", error);
        showError("Failed to initialize the application. Please refresh the page.");
      }
    };

    // Start the app
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>